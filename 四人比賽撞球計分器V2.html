<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››äººæ’çƒæ¯”è³½è¨ˆåˆ†å™¨ (å«è¨ˆæ™‚åŠè¨˜éŒ„)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --panel-bg: #2d2d2d;
            --accent-green: #27ae60;
            --accent-red: #c0392b;
            --accent-blue: #2980b9; 
            --accent-yellow: #f39c12; 
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 {
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 3px solid var(--accent-green);
            padding-bottom: 5px;
            text-align: center;
        }

        /* Status Display */
        #match-status-display {
            background-color: #333;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            width: 90%;
            max-width: 800px;
            color: #eee;
            border: 1px solid #555;
        }
        #timer-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-yellow);
            margin-top: 5px;
        }
        .status-text {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        /* Scoreboard Container */
        .scoreboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 1000px; 
            gap: 20px;
            opacity: 0.5; /* åˆå§‹æœªé–‹å§‹æ¯”è³½æ™‚è®Šæš— */
            transition: opacity 0.5s;
        }
        .scoreboard.active {
             opacity: 1;
        }

        /* Player Panel */
        .player-card {
            background-color: var(--panel-bg);
            border-radius: 15px;
            padding: 20px;
            flex: 1 1 300px; 
            max-width: 480px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border: 2px solid transparent;
            transition: border 0.3s, transform 0.2s;
            position: relative;
        }

        /* å„ç©å®¶çš„å¼·èª¿è‰² */
        #p1-card:focus-within { border-color: var(--accent-green); }
        #p2-card:focus-within { border-color: var(--accent-red); }
        #p3-card:focus-within { border-color: var(--accent-blue); }
        #p4-card:focus-within { border-color: var(--accent-yellow); }

        /* Name Input */
        input.player-name {
            background: transparent;
            border: none;
            border-bottom: 2px solid #555;
            color: var(--text-main);
            font-size: 1.5rem;
            text-align: center;
            width: 90%;
            margin-bottom: 15px;
            outline: none;
            padding: 5px;
            font-weight: bold;
        }

        input.player-name:focus {
            border-color: #fff;
        }

        /* Big Score (Racks/Games Won) - é€™è£¡ç¾åœ¨æ˜¯è¼ƒå°çš„å±€æ•¸ */
        .score-section {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
        }

        .score-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .big-score {
            font-size: 2.5rem; 
            font-weight: bold;
            line-height: 1;
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
            color: #ccc; 
        }

        /* Controls */
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 80%;
            margin: 0 auto;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 8px;
            padding: 8px 0; 
            font-size: 1.5rem;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.2s, background-color 0.2s;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-add {
            flex: 2;
        }
        
        /* ç‚ºä¸åŒç©å®¶è¨­å®šæŒ‰éˆ•é¡è‰² */
        #p1-card .btn-add { background-color: var(--accent-green); }
        #p2-card .btn-add { background-color: var(--accent-red); }
        #p3-card .btn-add { background-color: var(--accent-blue); }
        #p4-card .btn-add { background-color: var(--accent-yellow); color: #222; } 

        .btn-sub {
            background-color: #444;
            flex: 1;
        }

        .btn-sub:hover {
            background-color: #666;
        }

        /* Secondary Score (Small Points / Balls) -> ç¾åœ¨è®Šæˆä¸»è¦å¤§å­— */
        .sub-score-area {
            margin-top: auto; 
            padding: 20px 10px; 
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        /* P1 å°åˆ†èƒŒæ™¯ - æ·±ç¶ è‰² */
        #p1-card .sub-score-area {
            background-color: #145A32; 
            border: 2px solid var(--accent-green);
        }

        /* P2 å°åˆ†èƒŒæ™¯ - æ·±ç´…è‰² */
        #p2-card .sub-score-area {
            background-color: #7B241C;
            border: 2px solid var(--accent-red);
        }
        
        /* P3 å°åˆ†èƒŒæ™¯ - æ·±è—è‰² */
        #p3-card .sub-score-area {
            background-color: #1A3656;
            border: 2px solid var(--accent-blue);
        }

        /* P4 å°åˆ†èƒŒæ™¯ - æ·±é»ƒ/æ©˜è‰² */
        #p4-card .sub-score-area {
            background-color: #8C5B00;
            border: 2px solid var(--accent-yellow);
        }

        .sub-score-val {
            font-size: 5.5rem; 
            font-weight: bold;
            color: #ffffff; 
            line-height: 1;
            margin: 0 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-variant-numeric: tabular-nums;
        }

        .btn-small {
            padding: 15px 20px; 
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 60px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* Global Controls */
        .global-controls {
            margin-top: 30px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Reset & Download Buttons */
        .btn-reset, .btn-download {
            background-color: #7f8c8d;
            padding: 12px 20px;
            font-size: 1rem;
            text-transform: uppercase;
            color: white;
            flex-grow: 1;
            min-width: 120px;
        }
        
        .btn-reset:hover { background-color: #95a5a6; }
        .btn-download { background-color: #34495e; }
        .btn-download:hover { background-color: #4a637d; }

        /* Match Control Button Styles */
        #btn-start-match, #btn-end-rack {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            flex-grow: 2;
            min-width: 180px;
        }
        #btn-start-match { background-color: var(--accent-green); }
        #btn-start-match:hover { background-color: #2ecc71; }
        #btn-end-rack { background-color: #e67e22; }
        #btn-end-rack:hover { background-color: #f39c12; }

        /* æŒ‰éˆ•ç¢ºèªç‹€æ…‹ (ç´…è‰²é–ƒçˆ) */
        button.confirming {
            background-color: #e74c3c !important;
            color: #fff !important;
            animation: pulse 0.5s infinite alternate;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .player-card {
                min-width: 100%; 
            }
            .big-score {
                font-size: 2rem;
            }
            .sub-score-val {
                font-size: 4rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .global-controls {
                flex-direction: column;
                width: 100%;
            }
            .global-controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <h1>ğŸ± å››äººæ’çƒè¨ˆåˆ†æ¿</h1>

    <div id="match-status-display">
        <div class="status-text" id="status-message">é»æ“Šã€Œé–‹å§‹æ¯”è³½ã€ä»¥å•Ÿç”¨è¨ˆåˆ†å’Œè¨ˆæ™‚åŠŸèƒ½ã€‚</div>
        <div id="timer-display">00:00:00</div>
    </div>

    <div class="global-controls">
        <button id="btn-start-match" onclick="startMatch()">é–‹å§‹æ¯”è³½</button>
        <!-- é è¨­éš±è— -->
        <button id="btn-end-rack" style="display:none;" onclick="endRack(this)">çµæŸä¸€å±€ (è¨˜éŒ„æˆç¸¾)</button>
        <button class="btn-reset" onclick="resetGame(this)">é‡ç½®æ‰€æœ‰åˆ†æ•¸</button>
        <button class="btn-download" onclick="downloadMatchLog()">ä¸‹è¼‰è¨˜éŒ„</button>
    </div>

    <div class="scoreboard" id="scoreboard-container">
        <!-- Player 1 -->
        <div class="player-card" id="p1-card">
            <input type="text" value="å¼µå‹‡å¯Œ" class="player-name" id="p1-name">
            
            <div class="score-section">
                <div class="score-label">å‹å±€æ•¸ (Racks)</div>
                <div class="big-score" id="p1-main-score">0</div>
                <div class="btn-group">
                    <button class="btn-sub" onclick="updateScore('p1', -1, 'main')" disabled>-</button>
                    <button class="btn-add" onclick="updateScore('p1', 1, 'main')" disabled>+</button>
                </div>
            </div>

            <div class="sub-score-area">
                <button class="btn-small btn-sub" onclick="updateScore('p1', -1, 'sub')" disabled>-</button>
                <div style="text-align: center;">
                    <span class="score-label">å°åˆ†</span><br>
                    <span class="sub-score-val" id="p1-sub-score">0</span>
                </div>
                <button class="btn-small btn-add" onclick="updateScore('p1', 1, 'sub')" disabled>+</button>
            </div>
        </div>

        <!-- Player 2 -->
        <div class="player-card" id="p2-card">
            <input type="text" value="æé †è‹±" class="player-name" id="p2-name">
            
            <div class="score-section">
                <div class="score-label">å‹å±€æ•¸ (Racks)</div>
                <div class="big-score" id="p2-main-score">0</div>
                <div class="btn-group">
                    <button class="btn-sub" onclick="updateScore('p2', -1, 'main')" disabled>-</button>
                    <button class="btn-add" onclick="updateScore('p2', 1, 'main')" disabled>+</button>
                </div>
            </div>

            <div class="sub-score-area">
                <button class="btn-small btn-sub" onclick="updateScore('p2', -1, 'sub')" disabled>-</button>
                <div style="text-align: center;">
                    <span class="score-label">å°åˆ†</span><br>
                    <span class="sub-score-val" id="p2-sub-score">0</span>
                </div>
                <button class="btn-small btn-add" onclick="updateScore('p2', 1, 'sub')" disabled>+</button>
            </div>
        </div>

        <!-- Player 3 -->
        <div class="player-card" id="p3-card">
            <input type="text" value="å¼µç¾©" class="player-name" id="p3-name">
            
            <div class="score-section">
                <div class="score-label">å‹å±€æ•¸ (Racks)</div>
                <div class="big-score" id="p3-main-score">0</div>
                <div class="btn-group">
                    <button class="btn-sub" onclick="updateScore('p3', -1, 'main')" disabled>-</button>
                    <button class="btn-add" onclick="updateScore('p3', 1, 'main')" disabled>+</button>
                </div>
            </div>

            <div class="sub-score-area">
                <button class="btn-small btn-sub" onclick="updateScore('p3', -1, 'sub')" disabled>-</button>
                <div style="text-align: center;">
                    <span class="score-label">å°åˆ†</span><br>
                    <span class="sub-score-val" id="p3-sub-score">0</span>
                </div>
                <button class="btn-small btn-add" onclick="updateScore('p3', 1, 'sub')" disabled>+</button>
            </div>
        </div>

        <!-- Player 4 -->
        <div class="player-card" id="p4-card">
            <input type="text" value="å¼µå¹³" class="player-name" id="p4-name">
            
            <div class="score-section">
                <div class="score-label">å‹å±€æ•¸ (Racks)</div>
                <div class="big-score" id="p4-main-score">0</div>
                <div class="btn-group">
                    <button class="btn-sub" onclick="updateScore('p4', -1, 'main')" disabled>-</button>
                    <button class="btn-add" onclick="updateScore('p4', 1, 'main')" disabled>+</button>
                </div>
            </div>

            <div class="sub-score-area">
                <button class="btn-small btn-sub" onclick="updateScore('p4', -1, 'sub')" disabled>-</button>
                <div style="text-align: center;">
                    <span class="score-label">å°åˆ†</span><br>
                    <span class="sub-score-val" id="p4-sub-score">0</span>
                </div>
                <button class="btn-small btn-add" onclick="updateScore('p4', 1, 'sub')" disabled>+</button>
            </div>
        </div>
    </div>

    <script>
        // Initial State and Match Variables
        const players = ['p1', 'p2', 'p3', 'p4'];
        const scores = {
            p1: { main: 0, sub: 0, name: 'å¼µå‹‡å¯Œ' },
            p2: { main: 0, sub: 0, name: 'æé †è‹±' },
            p3: { main: 0, sub: 0, name: 'å¼µç¾©' },
            p4: { main: 0, sub: 0, name: 'å¼µå¹³' }
        };
        let matchHistory = [];
        let matchStartTime = null;
        let rackStartTime = null;
        let isMatchActive = false;
        let timerInterval = null;
        let currentRack = 0;

        // DOM Elements
        const scoreboardContainer = document.getElementById('scoreboard-container');
        const startBtn = document.getElementById('btn-start-match');
        const endRackBtn = document.getElementById('btn-end-rack');
        const statusMsg = document.getElementById('status-message');
        const timerDisplay = document.getElementById('timer-display');
        const allScoreButtons = document.querySelectorAll('.player-card button');
        const allNameInputs = document.querySelectorAll('.player-name');

        /**
         * æ ¼å¼åŒ–æ™‚é–“ (å¾æ¯«ç§’è½‰ç‚º H:MM:SS)
         */
        function formatDuration(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => num.toString().padStart(2, '0');

            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        /**
         * æ›´æ–°è¨ˆåˆ†å™¨çš„æŒ‰éˆ•ç¦ç”¨ç‹€æ…‹
         */
        function setScoreboardActive(active) {
            scoreboardContainer.classList.toggle('active', active);
            allScoreButtons.forEach(btn => {
                btn.disabled = !active;
            });
            allNameInputs.forEach(input => {
                input.readOnly = active; // æ¯”è³½é–‹å§‹å¾Œï¼Œåå­—ä¸èƒ½ä¿®æ”¹
            });
        }

        /**
         * æ›´æ–°æ¯”è³½æ™‚é–“é¡¯ç¤º
         */
        function updateTimerDisplay() {
            if (!rackStartTime) return;
            const elapsed = Date.now() - rackStartTime;
            timerDisplay.innerText = formatDuration(elapsed);
            statusMsg.innerHTML = `æ¯”è³½ä¸­... ç¬¬ **${currentRack}** å±€å·²é€²è¡Œï¼š`;
        }

        /**
         * é–‹å§‹æ¯”è³½
         */
        function startMatch() {
            if (isMatchActive) return;

            // è®€å–ç©å®¶åç¨±
            players.forEach(p => {
                scores[p].name = document.getElementById(`${p}-name`).value || `ç©å®¶ ${p.slice(-1)}`;
            });

            matchStartTime = Date.now();
            rackStartTime = matchStartTime;
            isMatchActive = true;
            currentRack = 1;

            startBtn.style.display = 'none';
            endRackBtn.style.display = 'block';
            setScoreboardActive(true);
            
            // é–‹å§‹è¨ˆæ™‚å™¨
            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
        }

        /**
         * æ›´æ–°åˆ†æ•¸ (èˆ‡ä¸Šä¸€å€‹ç‰ˆæœ¬ç›¸åŒï¼Œä½†ä¸é™åˆ¶è² æ•¸)
         */
        function updateScore(player, change, type) {
            // Update internal state
            scores[player][type] += change;

            // Update DOM
            const elementId = `${player}-${type}-score`;
            const element = document.getElementById(elementId);
            
            // Add simple animation class and coloring for feedback
            element.style.transform = "scale(1.2)";
            if (scores[player][type] < 0) {
                 element.style.color = "#e74c3c"; // è² åˆ†ç´…è‰²
            } else {
                 element.style.color = change > 0 ? "#2ecc71" : "#c0392b"; // æ­£åˆ†ç¶ è‰²/æ¸›åˆ†ç´…è‰²
            }
            
            setTimeout(() => {
                element.style.transform = "scale(1)";
                element.style.color = ""; // Reset color
            }, 150);

            element.innerText = scores[player][type];
        }

        /**
         * çµæŸä¸€å±€ï¼Œè¨ˆç®—æˆç¸¾ä¸¦è¨˜éŒ„
         */
        function handleEndRack() {
            if (!isMatchActive) return;

            const rackEndTime = Date.now();
            const duration = rackEndTime - rackStartTime;
            const durationFormatted = formatDuration(duration);

            // 1. æ‰¾å‡ºå°åˆ†æœ€é«˜çš„ç©å®¶
            let maxScore = -Infinity;
            let winnerCandidates = [];
            
            players.forEach(player => {
                const subScore = scores[player].sub;
                if (subScore > maxScore) {
                    maxScore = subScore;
                    winnerCandidates = [player];
                } else if (subScore === maxScore) {
                    winnerCandidates.push(player);
                }
            });

            let rackWinner = null;
            let logMessage = `ç¬¬ ${currentRack} å±€çµæŸï¼Œæ­·æ™‚ ${durationFormatted}ã€‚`;
            
            if (maxScore > 0 && winnerCandidates.length === 1) {
                // æœ‰æ˜ç¢ºè´å®¶ä¸”åˆ†æ•¸å¤§æ–¼0ï¼Œè‡ªå‹•åŠ åˆ†
                rackWinner = winnerCandidates[0];
                scores[rackWinner].main += 1;
                document.getElementById(`${rackWinner}-main-score`).innerText = scores[rackWinner].main;
                logMessage += ` è´å®¶: ${scores[rackWinner].name} (${maxScore} åˆ†).`;
            } else if (maxScore <= 0) {
                logMessage += ` ç„¡äººå¾—åˆ† (æœ€é«˜åˆ† 0 æˆ–è² åˆ†).`;
            } else { // winnerCandidates.length > 1
                 logMessage += ` å¹³æ‰‹ (æœ€é«˜åˆ† ${maxScore} åˆ†, å¹³æ‰‹ç©å®¶: ${winnerCandidates.map(p => scores[p].name).join('ã€')})ã€‚å‹å±€æ•¸è«‹æ‰‹å‹•èª¿æ•´ã€‚`;
            }

            // 2. è¨˜éŒ„æœ¬å±€æˆç¸¾
            const rackLog = {
                rack: currentRack,
                startTime: new Date(rackStartTime).toLocaleString('zh-TW'),
                endTime: new Date(rackEndTime).toLocaleString('zh-TW'),
                duration: durationFormatted,
                winner: rackWinner ? scores[rackWinner].name : 'ç„¡æ˜ç¢ºè´å®¶',
                p1_name: scores.p1.name, p1_score: scores.p1.sub,
                p2_name: scores.p2.name, p2_score: scores.p2.sub,
                p3_name: scores.p3.name, p3_score: scores.p3.sub,
                p4_name: scores.p4.name, p4_score: scores.p4.sub,
                message: logMessage
            };
            matchHistory.push(rackLog);

            // 3. é‡ç½®å°åˆ†ä¸¦é–‹å§‹ä¸‹ä¸€å±€è¨ˆæ™‚
            players.forEach(player => {
                scores[player].sub = 0;
                document.getElementById(`${player}-sub-score`).innerText = 0;
            });

            currentRack++;
            rackStartTime = Date.now(); // é–‹å§‹ä¸‹ä¸€å±€è¨ˆæ™‚
            updateTimerDisplay(); // æ›´æ–°é¡¯ç¤º

            // ç°¡å–®æç¤º
            statusMsg.innerHTML = logMessage + `<br>é–‹å§‹ç¬¬ **${currentRack}** å±€è¨ˆæ™‚...`;
            console.log(logMessage, rackLog);
        }

        /**
         * çµæŸä¸€å±€æŒ‰éˆ•çš„äºŒæ¬¡ç¢ºèª
         */
        function endRack(btn) {
            handleResetRequest(btn, handleEndRack, "ç¢ºå®šçµæŸæœ¬å±€ï¼Ÿ");
        }


        // --- æŒ‰éˆ•ç¢ºèªæ©Ÿåˆ¶é‚è¼¯ (é›™æ“Šç¢ºèª) ---
        let confirmTimer = null;

        function handleResetRequest(btnElement, actionCallback, confirmText) {
            if (btnElement.dataset.confirming === "true") {
                actionCallback();
                resetButtonState(btnElement);
            } else {
                document.querySelectorAll('.confirming').forEach(el => resetButtonState(el));
                
                const originalText = btnElement.innerText;
                btnElement.dataset.originalText = originalText;
                
                btnElement.dataset.confirming = "true";
                btnElement.innerText = confirmText || "ç¢ºå®šå—ï¼Ÿ";
                btnElement.classList.add('confirming');
                
                confirmTimer = setTimeout(() => {
                    resetButtonState(btnElement);
                }, 3000);
            }
        }

        function resetButtonState(btnElement) {
            if (btnElement && btnElement.dataset.confirming === "true") {
                btnElement.innerText = btnElement.dataset.originalText;
                btnElement.dataset.confirming = "false";
                btnElement.classList.remove('confirming');
                if(confirmTimer) clearTimeout(confirmTimer);
                confirmTimer = null;
            }
        }

        /**
         * é‡ç½®æ•´å ´æ¯”è³½
         */
        function handleResetGame() {
            if (timerInterval) clearInterval(timerInterval);
            isMatchActive = false;
            
            // é‡ç½®åˆ†æ•¸
            players.forEach(player => {
                scores[player].main = 0;
                scores[player].sub = 0;
                document.getElementById(`${player}-main-score`).innerText = 0;
                document.getElementById(`${player}-sub-score`).innerText = 0;
            });
            
            // é‡ç½®è¨ˆæ™‚èˆ‡è¨˜éŒ„
            matchStartTime = null;
            rackStartTime = null;
            currentRack = 0;
            matchHistory = [];

            // é‡ç½® UI
            timerDisplay.innerText = "00:00:00";
            statusMsg.innerHTML = "æ¯”è³½å·²é‡ç½®ã€‚é»æ“Šã€Œé–‹å§‹æ¯”è³½ã€ä»¥é–‹å§‹æ–°å±€ã€‚";
            startBtn.style.display = 'block';
            endRackBtn.style.display = 'none';
            setScoreboardActive(false);

            console.log("æ¯”è³½å·²é‡ç½®ã€‚");
        }

        function resetGame(btn) {
             handleResetRequest(btn, handleResetGame, "ç¢ºå®šé‡ç½®æ¯”è³½ï¼Ÿ");
        }


        /**
         * ä¸‹è¼‰æ¯”è³½è¨˜éŒ„
         */
        function downloadMatchLog() {
            if (matchHistory.length === 0) {
                alert("ç›®å‰æ²’æœ‰ä»»ä½•å·²å®Œæˆçš„å±€æ•¸è¨˜éŒ„å¯ä»¥ä¸‹è¼‰ã€‚");
                return;
            }

            // ç¸½çµè¨˜éŒ„
            const totalDuration = Date.now() - matchStartTime;
            const finalSummary = [
                ["--- æ¯”è³½ç¸½çµ ---"],
                ["ç¸½é–‹å§‹æ™‚é–“:", new Date(matchStartTime).toLocaleString('zh-TW')],
                ["ç¸½çµæŸæ™‚é–“:", new Date().toLocaleString('zh-TW')],
                ["ç¸½è€—æ™‚:", formatDuration(totalDuration)],
                ["ç¸½å±€æ•¸:", currentRack - 1],
                ["æœ€çµ‚æˆç¸¾", scores.p1.name, scores.p2.name, scores.p3.name, scores.p4.name],
                ["å‹å±€æ•¸ (Racks)", scores.p1.main, scores.p2.main, scores.p3.main, scores.p4.main],
                [],
                ["--- è©³ç´°å±€æ•¸è¨˜éŒ„ ---"]
            ];

            // æº–å‚™ CSV è³‡æ–™
            const header = [
                "å±€æ•¸", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "æ­·æ™‚", "å‹è€…",
                `P1 (${scores.p1.name}) å°åˆ†`,
                `P2 (${scores.p2.name}) å°åˆ†`,
                `P3 (${scores.p3.name}) å°åˆ†`,
                `P4 (${scores.p4.name}) å°åˆ†`,
                "å‚™è¨»"
            ];

            const csvRows = matchHistory.map(log => [
                log.rack, 
                log.startTime, 
                log.endTime, 
                log.duration, 
                log.winner, 
                log.p1_score, 
                log.p2_score, 
                log.p3_score, 
                log.p4_score, 
                log.message.replace(/,/g, '') // ç§»é™¤å‚™è¨»ä¸­çš„é€—è™Ÿä»¥é¿å…ç ´å£ CSV æ ¼å¼
            ]);

            // çµ„åˆæˆå®Œæ•´çš„ CSV å…§å®¹
            let csvContent = finalSummary.map(e => e.join(',')).join('\n') + '\n';
            csvContent += header.join(',') + '\n';
            csvContent += csvRows.map(row => row.join(',')).join('\n');


            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ’çƒæ¯”è³½è¨˜éŒ„_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // åˆå§‹è¨­å®šæŒ‰éˆ•ç¦ç”¨ç‹€æ…‹
        setScoreboardActive(false);

    </script>
</body>
</html>